<!DOCTYPE html>
<!-- This site was created with Wowchemy. https://www.wowchemy.com -->
<!-- Last Published: July 26, 2025 --><html lang="en-us" >


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.7.0 for Hugo" />
  

  
  












  
  










  







  
  
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    
      
      <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
  

  
  

  
  
    
    <script src="/js/mathjax-config.js"></script>
  

  

  <link rel="stylesheet" href="/css/vendor-bundle.min.16f785cdb553c8c4431db6775122af35.css" media="print" onload="this.media='all'">

  
  
  
    
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css" integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    
    
    
    
      
      
    
    
    

    
    
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.0f229d4b7ebad1917a9a357cba2effab.css" />

  
  
  

  
  
  
  
  
  
  
    
    
    <link rel="stylesheet" href="/css/libs/chroma/github-light.min.css" title="hl-light" media="print" onload="this.media='all'" >
    <link rel="stylesheet" href="/css/libs/chroma/dracula.min.css" title="hl-dark" media="print" onload="this.media='all'" disabled>
  

  
  


























  
  
  






  <meta name="author" content="Patrick Aschermayr" />





  

<meta name="description" content="MCMC for State Space Model Estimation" />



<link rel="alternate" hreflang="en-us" href="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/" />
<link rel="canonical" href="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/" />



  <link rel="manifest" href="/manifest.webmanifest" />



<link rel="icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png" />
<link rel="apple-touch-icon" type="image/png" href="/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png" />

<meta name="theme-color" content="#1565c0" />










  






<meta property="twitter:card" content="summary_large_image" />

  <meta property="twitter:site" content="@paschermayr" />
  <meta property="twitter:creator" content="@paschermayr" />
<meta property="twitter:image" content="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/featured.jpg" />
<meta property="og:site_name" content="Welcome!" />
<meta property="og:url" content="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/" />
<meta property="og:title" content="Bayesian Inference on State Space Models - Part 3 | Welcome!" />
<meta property="og:description" content="MCMC for State Space Model Estimation" /><meta property="og:image" content="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/featured.jpg" /><meta property="og:locale" content="en-us" />

  
    <meta
      property="article:published_time"
      content="2020-10-30T00:00:00&#43;00:00"
    />
  
  
    <meta property="article:modified_time" content="2020-10-30T00:00:00&#43;00:00">
  






    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/"
  },
  "headline": "Bayesian Inference on State Space Models - Part 3",
  
  "image": [
    "https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-3/featured.jpg"
  ],
  
  "datePublished": "2020-10-30T00:00:00Z",
  "dateModified": "2020-10-30T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Patrick Aschermayr"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Welcome!",
    "logo": {
      "@type": "ImageObject",
      "url": "https://paschermayr.github.io/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "MCMC for State Space Model Estimation"
}
</script>

  

  




  
  
  

  
  

  


  
  <title>Bayesian Inference on State Space Models - Part 3 | Welcome!</title>

  
  
  
  











</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="5bba9f1275c458247441f6e255d3504a" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.ec9d49ca50e4b80bdb08f0417a28ed84.js"></script>

  




  <div class="page-header header--fixed">
  
  
  
  
  












<header>
  <nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
    <div class="container-xl">

      
      <div class="d-none d-lg-inline-flex">
        <a class="navbar-brand" href="/">Welcome!</a>
      </div>
      

      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle navigation">
      <span><i class="fas fa-bars"></i></span>
      </button>
      

      
      <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
        <a class="navbar-brand" href="/">Welcome!</a>
      </div>
      

      
      
      <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

        
        <ul class="navbar-nav d-md-inline-flex">
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#about"><span>Home</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#projects"><span>Projects</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#opensource"><span>Open Source</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#posts"><span>Posts</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#talks"><span>Talks</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#publications"><span>Publications</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
          

          <li class="nav-item">
            <a class="nav-link " href="/uploads/resume.pdf"><span>CV</span></a>
          </li>

          
          

          

          
          
          
            
          

          

          
          
          
          

          
            
              
              
            
            
              
              
              
                
              
              
            
          

          <li class="nav-item">
            <a class="nav-link " href="/#contact"><span>Contact</span></a>
          </li>

          
          

        

          
        </ul>
      </div>

      <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

        
        
          
            
            <li class="nav-item d-none d-lg-inline-flex">
              <a class="nav-link" href="https://twitter.com/PAschermayr" data-toggle="tooltip" data-placement="bottom" title="Follow me on Twitter" target="_blank" rel="noopener" aria-label="Follow me on Twitter">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
            </li>
          
        

        
        
        
        <li class="nav-item">
          <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        
        
        
        <li class="nav-item dropdown theme-dropdown">
          <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
            <i class="fas fa-moon" aria-hidden="true"></i>
          </a>
          <div class="dropdown-menu">
            <a href="#" class="dropdown-item js-set-theme-light">
              <span>Light</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-dark">
              <span>Dark</span>
            </a>
            <a href="#" class="dropdown-item js-set-theme-auto">
              <span>Automatic</span>
            </a>
          </div>
        </li>
        

        
        

      </ul>

    </div>
  </nav>
</header>


  </div>

  <div class="page-body">
    
    
    

    <article class="article">

  






















  
  


<div class="article-container pt-3">
  <h1>Bayesian Inference on State Space Models - Part 3</h1>

  
  <p class="page-subtitle">MCMC for State Space Model Estimation</p>
  

  


<div class="article-metadata">

  
  
  
  
  <div>
    

  <span class="author-highlighted">
      Patrick Aschermayr</span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    Oct 30, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    8 min read
  </span>
  

  
  
  
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="/category/state-space-models/">State Space Models</a></span>
  

</div>

  





</div>


<div class="article-header container featured-image-wrapper mt-4 mb-4" style="max-width: 1200px; max-height: 688px;">
  <div style="position: relative">
    <img src="/post/statespacemodels-3-inference-on-state-space-models-part-3/featured_hu9877233ba78debaaae6e4e08b72ab3d6_1003078_1200x2500_fit_q75_h2_lanczos.webp" width="1200" height="688" alt="" class="featured-image">
    <span class="article-header-caption">Image credit: <a href="https://en.wikipedia.org/wiki/Monte_Carlo" target="_blank" rel="noopener"><strong>Monte Carlo</strong></a></span>
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      <h1 id="almost-done">Almost done!</h1>
<p>In my previous blog posts
<a href="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-1/" target="_blank" rel="noopener">here</a>
and <a href="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-2/" target="_blank" rel="noopener">here</a>,
we explored a general framework on how to conduct parameter estimation
for state space models (SSM), and took a first step in implementing this machinery. In order to
apply Particle MCMC (PMCMC), we have to</p>
<ul>
<li>
<ol>
<li>Find a good proposal distribution $f(\theta^{\star} \mid \theta)$ for $ \theta^{\star}$.</li>
</ol>
</li>
<li>
<ol start="2">
<li>Find a good proposal distribution $P(s^\star_{1:T} \mid \theta^{\star}, e_{1:T})$ for $ S^{\star}_{1:T}$.</li>
</ol>
</li>
<li>
<ol start="3">
<li>Find a sufficiently &lsquo;good&rsquo; likelihood approximation 

$\hat{\mathcal{L}}$$_{\theta}(e_{1:T})$ that we can plug into the acceptance rate.</li>
</ol>
</li>
</ul>
<p>We have already tackled the latter two problems in the previous posts, so what about the first one?</p>
<h1 id="the-mcmc-in-pmcmc">The MCMC in PMCMC</h1>
<p>If we want to jointly sample the parameter vector $\theta$, the first thing we need to do is to check the corresponding boundary conditions
of our parameter. For instance, if we want to estimate parameter of univariate normal observations, the mean parameter is
typically defined on the whole Reals, while the variance is constrained to be positive. There are several ways to proceed:</p>
<ul>
<li>
<p>i. We could, in principle, use some multivariate proposal distribution $f( . \mid \theta)$, and reject all proposals where one of the parameter
falls outside of the corresponding boundaries. This is, as you already guessed, very wasteful.</p>
</li>
<li>
<p>ii. Alternatively, you could use a truncated multivariate proposal distribution. Note that this is NOT the same as (i.), as one needs
to adjust the normalisation constants in the MH acceptance ratio, see
<a href="https://darrenjw.wordpress.com/tag/truncate/" target="_blank" rel="noopener">this blog post</a> for a more detailed explanation.
This approach is intuitively more efficient than the first option, but highly model specific and sometimes difficult to track for errors.</p>
</li>
<li>
<p>iii. Another possibility is to first transform the corresponding parameter into an unconstrained space, perform the MCMC step in this
unconstrained space, and then transform the proposed parameter back into the original space for the likelihood evaluation.
In this case, we have to be careful when calculating the prior. As we are now working with the transformed
parameter, we need to adjust the prior distribution with the Jacobian of the transform (keyword: push-forward measure). If you have trouble understanding that,
I recommend <a href="https://stats.stackexchange.com/questions/174962/when-re-parametrizing-a-likelihood-function-is-it-enough-just-to-plug-in-the-tr" target="_blank" rel="noopener">this explanation</a>
before you proceed reading.
This approach has a much higher initial workload, but to my mind is the most general and effective way to perform
MCMC, and almost all libraries that you use work in this way under the hood. Consequently, we will focus on the third case.</p>
</li>
</ul>
<p>So, how can we code this up? The most straightforward way to implement this approach is by using information from the corresponding
prior: boundaries, length and dimension of each parameter can be inferred from here. I will use a new Julia package
<a href="https://github.com/TuringLang/Bijectors.jl" target="_blank" rel="noopener">Bijectors.jl</a> that makes the workflow significantly easier, but there are similar packages
in other languages as well.</p>
<h1 id="coding-it-all-up">Coding it all up</h1>
<p>In my <a href="https://paschermayr.github.io/post/statespacemodels-3-inference-on-state-space-models-part-2/" target="_blank" rel="noopener">last post</a>, we implemented a particle
filter for basic hidden Markov models, so let us continue to use this example.
Hence, we are interested in the mean and variance parameter for each state, and the corresponding transition matrix of the
latent Markov chain. For now, let us assume the transition matrix is known, so we can implement
the MCMC machinery for scalar based parameter, and do not need to extend our functions for vector valued parameter. To my mind,
this would put too much attention to the code rather than the actual topic.
We start by creating a container that can hold one parameter and its corresponding priors.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="k">using</span> <span class="n">Distributions</span><span class="p">,</span> <span class="n">Bijectors</span><span class="p">,</span> <span class="n">Parameters</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="n">Base</span><span class="o">:</span> <span class="n">count</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#A container with necessary information about θ</span>
</span></span><span class="line"><span class="cl"><span class="k">mutable struct</span> <span class="kt">ParamInfo</span><span class="p">{</span><span class="kt">T</span><span class="p">,</span> <span class="kt">D</span><span class="o">&lt;:</span><span class="kt">Union</span><span class="p">{</span><span class="kt">Nothing</span><span class="p">,</span> <span class="o">&lt;:</span><span class="kt">Distributions</span><span class="o">.</span><span class="kt">Distribution</span><span class="p">}</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span>   <span class="o">::</span> <span class="n">T</span> <span class="c">#Can be Real, Integer, or a Arrays composed of it</span>
</span></span><span class="line"><span class="cl">    <span class="n">prior</span>   <span class="o">::</span> <span class="n">D</span> <span class="c">#Corresponding prior of value, needs to fulfill boundary constraints!</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="n">ParamInfo</span><span class="p">(</span><span class="n">value</span><span class="o">::</span><span class="kt">T</span><span class="p">)</span> <span class="k">where</span> <span class="p">{</span><span class="kt">T</span><span class="p">}</span> <span class="o">=</span> <span class="n">ParamInfo</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">nothing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#Check the number of parameter in ParamInfo struct</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">count</span><span class="p">(</span><span class="n">paraminfo</span><span class="o">::</span><span class="kt">ParamInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">length</span><span class="p">(</span><span class="n">paraminfo</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">count (generic function with 17 methods)
</span></span></code></pre></div><p>Note that I also defined a function that informs us about the parameter size inside this container. Next, we will make a
summary container for all the different parameter that we will need during the tutorial - i.e., mean and variance parameter of a univariate Normal distribution
for each state in the basic HMM case.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">#A summary container for all relevant parameter</span>
</span></span><span class="line"><span class="cl"><span class="k">mutable struct</span> <span class="kt">HMMParameter</span>
</span></span><span class="line"><span class="cl">    <span class="n">μ</span>   <span class="o">::</span> <span class="kt">Vector</span><span class="p">{</span><span class="kt">ParamInfo</span><span class="p">}</span> <span class="c">#Observation Distribution Mean</span>
</span></span><span class="line"><span class="cl">    <span class="n">σ</span>   <span class="o">::</span> <span class="kt">Vector</span><span class="p">{</span><span class="kt">ParamInfo</span><span class="p">}</span> <span class="c">#Observation Distribution Variance</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>Further, we want to define some helper functions that enable us to transform and inverse transform the parameter
in said container. Remember that our goal is to sample from some unconstrained space, and then inverse transform said parameter back to our constrained space. This will help us to accept more parameter proposals in the MCMC step. Note that I will use a subscript t for
certain variables in order to indicate that the operation takes place in the transformed space.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">#Wrapper to transform θ into an unconstrained space</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">transform</span><span class="p">(</span><span class="n">parameter</span><span class="o">::</span><span class="kt">ParamInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Bijectors</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="c">#Wrapper to transform θₜ back into the original space, and store it in parameter struct</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">inverse_transform!</span><span class="p">(</span><span class="n">parameter</span><span class="o">::</span><span class="kt">ParamInfo</span><span class="p">,</span> <span class="n">θₜ</span><span class="o">::</span><span class="kt">T</span><span class="p">)</span> <span class="k">where</span> <span class="p">{</span><span class="kt">T</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">Bijectors</span><span class="o">.</span><span class="n">invlink</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span> <span class="n">θₜ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@pack!</span> <span class="n">parameter</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#The same two functions dispatched on the summary container</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">transform</span><span class="p">(</span><span class="n">parameter</span><span class="o">::</span><span class="kt">HMMParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">θₜ</span> <span class="o">=</span> <span class="kt">Float64</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">field_name</span> <span class="k">in</span> <span class="n">fieldnames</span><span class="p">(</span> <span class="n">typeof</span><span class="p">(</span> <span class="n">parameter</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_field</span> <span class="o">=</span> <span class="n">getfield</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">field_name</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">append!</span><span class="p">(</span><span class="n">θₜ</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="p">(</span><span class="n">sub_field</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">θₜ</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">inverse_transform!</span><span class="p">(</span><span class="n">parameter</span><span class="o">::</span><span class="kt">HMMParameter</span><span class="p">,</span> <span class="n">θₜ</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">T</span><span class="p">})</span> <span class="k">where</span> <span class="p">{</span><span class="kt">T</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">field_name</span> <span class="k">in</span> <span class="n">fieldnames</span><span class="p">(</span> <span class="n">typeof</span><span class="p">(</span> <span class="n">parameter</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_field</span> <span class="o">=</span> <span class="n">getfield</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">field_name</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dim</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span> <span class="n">count</span><span class="o">.</span><span class="p">(</span><span class="n">sub_field</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">inverse_transform!</span><span class="o">.</span><span class="p">(</span> <span class="n">sub_field</span><span class="p">,</span> <span class="n">θₜ</span><span class="p">[</span> <span class="n">counter</span><span class="o">:</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">counter</span> <span class="o">+</span> <span class="n">dim</span> <span class="p">)]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span> <span class="o">+=</span> <span class="n">dim</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">inverse_transform! (generic function with 2 methods)
</span></span></code></pre></div><p>We must define this for both the individual ParamInfo as well as the summary container. This is, admittedly, not a straightforward process. However,
the important part is that we now have a container that holds all the
unknown observation parameter that we need in the HMM case, and we can freely transform and inverse transform parameter
that are contained in there. If you understand this goal, then you are perfectly fine to continue.</p>
<p>As an example, let us now create an object that contains the mean and variance parameter of a univariate Normal two-state HMM. Next,
we transform all parameter into an unconstrained space, sample the transformed parameter and inverse transform them back into the original space:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">#Create a Vector of univariate Normal Model parameter and assign a prior to each of them:</span>
</span></span><span class="line"><span class="cl"><span class="n">μᵥ</span> <span class="o">=</span> <span class="p">[</span><span class="n">ParamInfo</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">Normal</span><span class="p">()</span> <span class="p">),</span> <span class="n">ParamInfo</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">Normal</span><span class="p">()</span> <span class="p">)]</span> <span class="c">#Initial value and Prior</span>
</span></span><span class="line"><span class="cl"><span class="n">σᵥ</span> <span class="o">=</span> <span class="p">[</span><span class="n">ParamInfo</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">()</span> <span class="p">),</span> <span class="n">ParamInfo</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)]</span> <span class="c">#Initial value and Prior</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">hmmparam</span> <span class="o">=</span> <span class="n">HMMParameter</span><span class="p">(</span><span class="n">μᵥ</span><span class="p">,</span> <span class="n">σᵥ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#Transform parameter:</span>
</span></span><span class="line"><span class="cl"><span class="n">transform</span><span class="p">(</span><span class="n">hmmparam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#Sample parameter from an unconstrained distribution, then inverse transform and plug into our container:</span>
</span></span><span class="line"><span class="cl"><span class="n">θₜ_proposed</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">inverse_transform!</span><span class="p">(</span><span class="n">hmmparam</span><span class="p">,</span> <span class="n">θₜ_proposed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">hmmparam</span> <span class="c">#Check that parameter in hmmparam fulfill boundary conditions</span>
</span></span></code></pre></div><p>Well done, we achieved our initial goal! You can run the above code several times, and will see that the plugged in
parameter in the constrained space will satisfy the corresponding boundary conditions, even though we sampled from a multivariate
Normal distribution. At the very beginning, I mentioned that when transforming parameter in an unconstrained space,
one has to adjust the corresponding prior. These adjustments will all be handeled by the Bijectors package, so
we can conveniently write a function that calculates the prior for each of our parameter and returns the sum of it.
This will be helpful when we run the PMCMC algorithm in the next blog post.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">#function to calculate prior including Jacobian adjustment</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">calculate_logπₜ</span><span class="p">(</span><span class="n">parameter</span><span class="o">::</span><span class="kt">ParamInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">logpdf_with_trans</span><span class="p">(</span><span class="n">parameter</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span> <span class="n">parameter</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">#Wrapper to calculate prior including jacobian adjustment on all parameter</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">calculate_logπₜ</span><span class="p">(</span><span class="n">parameter</span><span class="o">::</span><span class="kt">HMMParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">πₜ</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">field_name</span> <span class="k">in</span> <span class="n">fieldnames</span><span class="p">(</span> <span class="n">typeof</span><span class="p">(</span> <span class="n">parameter</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_field</span> <span class="o">=</span> <span class="n">getfield</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">field_name</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">πₜ</span> <span class="o">+=</span> <span class="n">sum</span><span class="p">(</span> <span class="n">calculate_logπₜ</span><span class="o">.</span><span class="p">(</span><span class="n">sub_field</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">πₜ</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">calculate_logπₜ (generic function with 2 methods)
</span></span></code></pre></div><p>Perfect! Now we are almost done for today,
the last thing to do is to create a MCMC sampler. We will use a straightforward Metropolis algorithm with a multivariate Normal proposal distribution.
As before, we will first define a container with all the necessary information and a function on it to sample via this object:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c"># Container with necessary information for a Metropolis MCMC step</span>
</span></span><span class="line"><span class="cl"><span class="k">mutable struct</span> <span class="kt">Metropolis</span><span class="p">{</span><span class="kt">T</span><span class="o">&lt;:</span><span class="kt">Real</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">θₜ</span>           <span class="o">::</span>  <span class="kt">Vector</span><span class="p">{</span><span class="kt">T</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">scaling</span>     <span class="o">::</span>  <span class="kt">Float64</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Function to propose a Metropolis step</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="n">propose</span><span class="p">(</span><span class="n">sampler</span><span class="o">::</span><span class="kt">Metropolis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@unpack</span> <span class="n">θₜ</span><span class="p">,</span> <span class="n">scaling</span> <span class="o">=</span> <span class="n">sampler</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rand</span><span class="p">(</span> <span class="n">MvNormal</span><span class="p">(</span><span class="n">θₜ</span><span class="p">,</span> <span class="n">scaling</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">propose (generic function with 1 method)
</span></span></code></pre></div><p>Scaling is a tuning parameter that determines how large the proposal steps for the parameter will be. The larger the tuning parameter,
the larger the proposed movements will be, which might result in a lower acceptance rate. Check this out yourself. At the end, we check our framework by assigning an initial parameter value
and sampling from there via this MCMC sampler:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-julia" data-lang="julia"><span class="line"><span class="cl"><span class="c">#Create an initial sampler, and propose new model parameter:</span>
</span></span><span class="line"><span class="cl"><span class="n">θₜ_inital</span> <span class="o">=</span> <span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">metropolissampler</span> <span class="o">=</span> <span class="n">Metropolis</span><span class="p">(</span><span class="n">θₜ_inital</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">length</span><span class="p">(</span><span class="n">θₜ_inital</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">propose</span><span class="p">(</span><span class="n">metropolissampler</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">4-element Array{Float64,1}:
</span></span><span class="line"><span class="cl"> -0.5791553185118626
</span></span><span class="line"><span class="cl">  0.5875000886407763
</span></span><span class="line"><span class="cl"> -0.09563827588507412
</span></span><span class="line"><span class="cl">  1.1869926689230335
</span></span></code></pre></div><h1 id="way-to-go">Way to go!</h1>
<p>This section was more straightforward than the previous one! We can now store, transform and inverse transform model parameter
of a basic HMM. We can also create a basic MCMC algorithm to sample said parameter. In my final post, we will combine the previous instalments of this series
and implement the PMCMC algorithm to estimate HMM model and state trajectory parameter jointly. See you soon!</p>

    </div>

    





<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/state-space-models/">State Space Models</a>
  
  <a class="badge badge-light" href="/tag/particle-mcmc/">Particle MCMC</a>
  
  <a class="badge badge-light" href="/tag/hidden-markov-model/">Hidden Markov Model</a>
  
  <a class="badge badge-light" href="/tag/markov-chain-monte-carlo/">Markov Chain Monte Carlo</a>
  
  <a class="badge badge-light" href="/tag/julia/">Julia</a>
  
</div>



<div class="share-box">
  <ul class="share">
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fpaschermayr.github.io%2Fpost%2Fstatespacemodels-3-inference-on-state-space-models-part-3%2F&amp;text=Bayesian&#43;Inference&#43;on&#43;State&#43;Space&#43;Models&#43;-&#43;Part&#43;3" target="_blank" rel="noopener" class="share-btn-twitter" aria-label="twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fpaschermayr.github.io%2Fpost%2Fstatespacemodels-3-inference-on-state-space-models-part-3%2F&amp;t=Bayesian&#43;Inference&#43;on&#43;State&#43;Space&#43;Models&#43;-&#43;Part&#43;3" target="_blank" rel="noopener" class="share-btn-facebook" aria-label="facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
        
      
      <li>
        <a href="mailto:?subject=Bayesian%20Inference%20on%20State%20Space%20Models%20-%20Part%203&amp;body=https%3A%2F%2Fpaschermayr.github.io%2Fpost%2Fstatespacemodels-3-inference-on-state-space-models-part-3%2F" target="_blank" rel="noopener" class="share-btn-email" aria-label="envelope">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fpaschermayr.github.io%2Fpost%2Fstatespacemodels-3-inference-on-state-space-models-part-3%2F&amp;title=Bayesian&#43;Inference&#43;on&#43;State&#43;Space&#43;Models&#43;-&#43;Part&#43;3" target="_blank" rel="noopener" class="share-btn-linkedin" aria-label="linkedin-in">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="whatsapp://send?text=Bayesian&#43;Inference&#43;on&#43;State&#43;Space&#43;Models&#43;-&#43;Part&#43;3%20https%3A%2F%2Fpaschermayr.github.io%2Fpost%2Fstatespacemodels-3-inference-on-state-space-models-part-3%2F" target="_blank" rel="noopener" class="share-btn-whatsapp" aria-label="whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fpaschermayr.github.io%2Fpost%2Fstatespacemodels-3-inference-on-state-space-models-part-3%2F&amp;title=Bayesian&#43;Inference&#43;on&#43;State&#43;Space&#43;Models&#43;-&#43;Part&#43;3" target="_blank" rel="noopener" class="share-btn-weibo" aria-label="weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  
    



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://paschermayr.github.io/"><img class="avatar mr-3 avatar-circle" src="/authors/admin/avatar_hu046b70cbbe8549775ddedf4ac50c4b43_1886234_270x270_fill_q75_lanczos_center.jpg" alt="Patrick Aschermayr"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://paschermayr.github.io/">Patrick Aschermayr</a></h5>
      <h6 class="card-subtitle">Quantitative Researcher at <a href="https://www.brevanhoward.com/" target="_blank" rel="noopener">Brevan Howard</a></h6>
      <p class="card-text">Seeking a challenging and research-driven environment where I can develop and make a meaningful contribution.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:paschermayr@gmail.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/PAschermayr" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=Patrick&#43;Aschermayr&amp;btnG=" target="_blank" rel="noopener">
        <i class="fas fa-graduation-cap"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/paschermayr" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/patrickaschermayr/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="/uploads/resume.pdf" >
        <i class="ai ai-cv"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  
















  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  












  
  
  
  
  













  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by copyright-license-text">
    © 2025 Me. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank">CC BY NC ND 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-nd fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a> — the free, <a href="https://github.com/wowchemy/wowchemy-hugo-themes" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>
</footer>

    </div>
    
  </div>

  


<script src="/js/vendor-bundle.min.32ee83730ed883becad04bc5170512cc.js"></script>




  

  
  

  






























<script id="page-data" type="application/json">{"use_headroom":true}</script>



  <script src="/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js" type="module"></script>










<script src="/en/js/wowchemy.min.c7af8ef9d6716c221ea3eb7b0c2bf640.js"></script>







  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <pre><code></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js" type="module"></script>


















</body>
</html>
